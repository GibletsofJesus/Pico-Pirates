pico-8 cartridge // http://www.pico-8.com
version 17
__lua__
cellwindx=.04
cellwindy=-.02

function newboat(isplayer,maxspeed)
	return {
		x=64,y=64,
		mx=0,my=0,r=0,
		maxvel=maxspeed,player=isplayer,
		update=function(b)
			local speed,c,s=.05,cos(b.r),sin(b.r)
			local sc=(s*s)+(c*c)

			if b.player then
				if(btn"0") b.r=b.r%1+.01
				if(btn"1") b.r=b.r%1-.01
			end

			b.mx+=cellwindy*.005
			b.my-=cellwindx*.005

			if b.player then
				if btn"2" then
					b.mx+=s*speed
					b.my-=c*speed
					sfx(0)
				else
					b.mx*=.99
					b.my*=.99
				end
			else
				local diffx=b.x-px
				local diffy=b.y-py
				local angle=atan2(diffx,diffy)-.25

				local dist=sqrt((b.y-player.y)^2+(b.x-player.x)^2)

				b.r=lerp(b.r,angle+.5,.1)
				if dist>48 then
					b.x=player.x+sin(angle)*40
					b.y=player.y-cos(angle)*40
 			 b.mx/=4
				 b.my/=4
					b.c=7
				elseif anglediff(b.r,atan2(px,py))<.5 then
				 b.mx+=s*speed
					b.my-=c*speed
					b.c=10
				else
					b.c=9
					b.mx*=.95
					b.my*=.95
				end
			end

			b.mx=mid(-b.maxvel,b.mx,b.maxvel)
			b.my=mid(-b.maxvel,b.my,b.maxvel)

			b.x=flr((b.x+b.mx)*2)/2
			b.y=flr((b.y+b.my)*2)/2
			if b.player then
				if (b.x>128) b.x-=128 npc.x-=128
				if (b.x<0) b.x+=128			npc.x+=128
				if (b.y>128) b.y-=128 npc.y-=128
				if (b.y<0) b.y+=128   npc.y+=128
			end
		end,
		draw=function(b)
			local c=b.c
			if (b.player) c=8
--			circfill(b.x,b.y,2,c)
--			line(b.x,b.y,b.x+sin(b.r)*8,b.y-cos(b.r)*8,c)

			spr_rot(-2,76,12,flr(b.x),flr(b.y),b.r,6)
		end
	}
end

function _init()
	player=newboat(true,2.5)
	npc=newboat(false,1.5)
end

function _update()
	npc.update(player)
	npc.update(npc)
end

camx=0
camy=0

function _draw()
	cls(12)
	?anglediff(npc.r,atan2(px,py))
	npc.draw(player)
	pal(4,2)
	pal(15,6)
	pal(7,13)
	pal(9,15)
	npc.draw(npc)
	pal()
	circ(player.x,player.y,24,1)

	--camx,camy=player.x-32,player.y-32
	if player.x < camx+24 then
		camx=player.x-24
	end
	if player.x > camx+40 then
		camx=player.x-40
	end
	if player.y < camy+24 then
		camy=player.y-24
	end
	if player.y > camy+40 then
		camy=player.y-40
	end

	rect(camx+24,camy+24,camx+40,camy+40,7)
	circfill(player.x,player.y,2,6)

	rect(camx,camy,camx+64,camy+64)

end

function anglediff(a,b)
	if (a>.5 and b<.5) b+=1
	if (b>.5 and a<.5) a+=1
	return abs(b-a)
end

function dotproduct(a,b)
	return a.mx*b.mx + a.my*b.my
end

function lerp(a,b,t)
 return b*t+(a*(1-t))
end


function spr_rot(sx,sy,swh,dx,dy,rot,depth)
	local s=sin(rot)
	local c=cos(rot)
	local size = swh/2
	local _b=(s*s+c*c)
	local w = sqrt(size^2*2)
	for y=-w,w do
		for x=-w,w do
			local ox=(s*y+c*x)/_b+size
			local oy=(-s*x+c*y)/_b+size
			if ox<swh and oy<swh and ox>0 and oy>0 then
				for d=0,depth do
					local col=sget(ox+sx+(d*12),oy+sy)
					if (col>0) pset(dx+x,dy+y-d,col)
				end
			end
		end
	end
end
__gfx__
0040000000040000000001d77000000000000007000000000000000011000000000000000000000000000000011111000010001000000000000000000000000d
7777000007670000011115d7000000000000000011000000000000811000000000000000000000000000000011111110001011111000000000000000000000df
0777700000767000022449a7000000066000000021100000000008890000000000000000000000000000000100001111001111111100000000000000000000df
077770000067670003399aa700000066660000003311000000008c888000000000000000000002000004400000000111011000011110000000000000000000df
777700000676700004499aa70000066666600000442210000000cc88800000000000000000002200000440000000011110100000111100000000000000000ddf
4040044020040022055dd66700006666666600005511000000044e98002000000023400000022650000040000000011100100000011110000000000000000dff
414144002212122006677777000000666600000066dd510000046ffd422200222277772220026777754400000000111100100000001110000000000000000dff
4444400022222200077777770000006666000000776dd51000467ffd722220024537777200277277755100000001011100100000001110000000000000000dff
01249af777fa00000888ee7700000066660000008882210000246fbb022200065510776400577200115100000110011100110000011110000000000000000ddf
012499aaa99000000999aaa7000000666600000099942100000467b10020000475102764005772000511000011100111001011111011100000000000000000df
00000000000000000aa777770000006666000000aa994210000467b10000000475102264405772004111000111110111001000000011100000000000000000df
00000000000000000bbaaa770000006666000000bbb33100000467b10000000677102260005772044551000001111111001000000011100000000000000000df
00000000000000000ccc77770000006666000000ccdd5110000467b1000000265530662000577604455500000011111100100000001110000000000000000ddf
00000000000000000dd666670000000000000000dd511000000467b1000000265516222000577640455500000000111100101111101110000000000000000dff
00000000000000000eeee7770000000000000000ee882210000467b1000002265550222000177600055500000000111100110000011110000000000000000dff
00000000000000000fffff777000000000000007fff9421000046731000002265510222000133600055500000000011100100000001110000000000000000dff
000000000000000000000000000000000000000000220000000467b1000002265510222000137200055500000000011100100000001110000000000000000ddf
aae5fba057770008eff908ff7daa0bffd9005dddd046617760046fb9010002267512222401173300055500000000011100100000001110000000000000000dff
0e501e088528d804d284008700f00c708500e14ad00632060046effbd20002677775327221377775251000000001111100111100001100000000000000000dff
06b3b60085f580050a04000f6e10007d4000a3d2a007023700046fff200000226755772000467777500000000111111100111111101000000000000000000dff
070816008d28900582850007807040b04e00a1e8a0070027000004b0000000020041020004000215000000011111111100111111110000000000000000000ddf
23edf320df7b8008dfd8007ff9600ffffb023dde2222755200000000000000000000000000000040000000110000011100100001100000000000000000000dff
10000000000000022004400000060000001000000000000020000000000000000000000000000000000000000000011100100000000000000000000000000dff
88000000000000000000000088800000000088800000000000000000000022000000000022200022200000000000011100100000000000000000000000000dff
2aa750aaa008801777740000008e73b9800006ff753aa80001bbffdd100006755555720004665157400000000000011100100000000000000000000000000ddf
02e9550a00009d40aa9d48800049e6090004512a845380000097208d1000062354037000006720070000000000000111110000000000000000000000000000df
06f8114b100008817e9140800459a2c00000006f90691000001768801000022354023000007720060000000000000000000000000000000000000000000000df
467993b6000008817fd400804551aa040000006fd68110000013ec500000020374302000017522060000000000000000000000000000000000000000000000df
067aa19640000089f69908000451aa0440000067be011000001bb154000002037530200000752217000000000000000000000000000000000000000000000ddf
07608817000000097609900004592a840000006798710000001fa010600002017610200000750227000000000000000000000000000000000000000000000dff
03608853000000097619800000c12ac0100000679871000000db200c200002017600200000650227000000000000000000000000000000000000000000000dff
133ecdb33000009ff7f88800088c77d90000047ff9960000019ffffb310022255542220002265572000000000000000000000000000000000000000000000dff
2000000000000000000000000000200c400002000000600000200000000000100000000000000002000000000000000000000000000000000000000000000ddf
000000000000000000000000022200008800000000000660000000000000000000000000000000002200000000000000000000000000000000000000000000df
0000000000000222220000000000002000000999999999994000007c0007c00000000000000000000000000000000000000000000000000000000000000000df
00000000000228888822000000000288000095555555555924008cb9a07a8a0000000000000000000000000000000000000000000000000000000000000000df
0000000002288882828820000000028e00095555555555922407b9a897c9ab000000000000000000000000000000000000000000000000000000000000000ddf
00000000288888882888820000000288009999999999999224c9ac797a9ac9000000000000000000000000000000000000000000000000000000000000000dff
0000000288888882828882000000028e0a11111111111144409b7a9c9ba990000000000000000000000000000000000000000000000000000000000000000dff
00000029888888288888820000000288a11111111111144000000000000000000000000000000000000000000000000000000000000000000000000000000dff
0000002a98888888888882000000028eaaaaaaaaaaa9424000000000000000000000000000000000000000000000000000000000000000000000000000000ddf
00000029a98889999888820000000288a222a1192229224000000000000000000000000000000000000000000000000000000000000000000000000000000dff
0000002898889aaa988882000000028ea288a1192889224000000000000000000000000000000000000000000000000000000000000000000000000000000dff
00000028888899998888200000000288a28889928889224000000000000000000000000000000000000000000000000000000000000000000000000000000dff
0000002888888888888820000000028ea28888888889224000000000000000000000000000000000000000000000000000000000000000000000000000000ddf
00000028888888888882000000000288a288888888892400000000000000000000000000000000000000000000000000000000000000000000000000000000df
0000002888888888882820000000028ea999999999994000000000000000000000000000000000000000000000000000000000000000000000000000000000df
0000028888888888228820000000028800aaaaaaaaaaa90088000008000000000000000000000000000000000000000000000000000000000000000000000ddf
0000288888888822882882000000028e0a2222222222924888800088800000000000000000000000000000000000000000000000000000000000000000000ddf
00028888888882882828820000000288a28888888889224188880888800000000000000000000000000000000000000000000000000000000000000000000dff
0028882288288288282882000000028ea2888aa28889244018888888100000000000000000000000000000000000000000000000000000000000000000000dff
02888288882882882822882280000288aaaaa1199999424001888881000000000000000000000000000000000000000000000000000000000000000000000dff
0288288222888828288228888000028ea222a1192229224008888810000000000000000000000000000000000000000000000000000000000000000000000000
02828820028888288288828820000288a288a1192889224088888880000000000000000000000000000000000000000000000000000000000000000000000000
2882882028828882882888220028028ea28889928889224888818888000000000000000000000000000000000000000000000000000000000000000000000000
28882882282028882882888822882288a28888888889224888101888800000000000000000000000000000000000000000000000000000000000000000000000
0288828288200288828828888882028ea28888888889240181000188100000000000000000000000000000000000000000000000000000000000000000000000
00282882820022882882022222200288a99999999999400010000011000000000000000000000000000000000000000000000000000000000000000000000000
0ddddd000ddddd0000000ddddddddddddddddddddd000ddddddddd000ddddd0000000ddddd0000000ddddddddd000ddddd000000000000000000000000000000
ddfffdddddfffdddd0ddddfffdfffdfffdfffdfffdddddfffdfffdddddfffdddd0ddddfffdddd0ddddfffdfffdddddfffdddd0ddd00000000000000000000000
dffffffffffffffffdfffffffffffffffffffffffffffffffffffffffffffffffdfffffffffffdfffffffffffffffffffffffdfffd0000000000000000000000
fff000ffffff00ffff000ffffff0000ffff000fffff00fff000ff000000ff00000ffff00fff00ff0ffffffff0fff000ffffffff0ffffff000000000000000000
0f00000f00f00f0000f0f00f00f000f000ff000f000f00ff000f00000000f0000f0000f00f0000f00f00f00f00f00000f00f00f00f0000f00000000000000000
00f000f000f0f00000f0000f00000f00000ff00f000f000f000f00000000f000f00000f00f0000f00f00f000000f000f000f00000f00000f0000000000000000
00f000f000f0f0000000000f0000f0000000f00f000f000f00f00000000fff00f00000000f0000f00f00f000000f000f000f00000f00000f0000000000000000
00f000f000f0f0000000000f0000f0000000f00f000f0000f0f00000000f0f00f00000000f0000f00f00f00f000f000f000f00f00f00000f0000000000000000
00f00f0000f0f0000000000f0000f0000000f00f00f00000ff000000000f0f00f00000000ffffff00f00ffff000f00f0000ffff00f00000f0000000000000000
000f0f0000f0f0000000000f0000f0000000f00fff000000ff00000000f00f00f00000000f0000f00f00f00f0000f0f0000f00f00f00000f0000000000000000
000f0f0000f0f0000000000f0000f0000000f00f0ff000000f00000000fffff0f00000000f0000f00f00f0000000f0f0000f00000f00000f0000000000000000
000f0f0000f0f0000000000f0000f0000000f00f00ff00000f00000000f000f0f00000000f0000f00f00f0000000f0f0000f00000f00000f0000000000000000
0000f00000f0ff0000f0000f00000f000000f00f00ff00000f00000000f000f0ff0000f00f0000f00f00f000f0000f00000f000f0f00000f0000000000000000
0000f00000f00f0000f0000f000000f0000f000f000ff0000f0000000f0000ff0f0000f00f0000f00f00f00f00000f00000f00f00f0000f00000000000000000
0000f0000fff00ffff00000ff000000ffff0000f0000f000ff000000ff0000ff00ffff00fff00fffffffffff00000f0000fffff0ffffff000000000000000000
00000000000000000000000000000000000000f0f000ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000ff000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000004000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000004000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0004440000000004f400000000040400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000444000000004fff40000000400040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000444000000004fff40000000400040000000000000000000077700000000007000000000000000000000000000000000000000000000000000000000000000
000444000000004fff40000000404040000000004000000000004000000000004000000000000000000000000000000000000000000000000000000000000000
000444000000004fff40000000400040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000444000000004fff40000000400040000000000000000000777770000000777770000000000000000000000000000000000000000000000000000000000000
000444000000004fff40000000404040000000404040000000004000000000004000000000004000000000000000000000000000000000000000000000000000
000444000000004fff40000000490940000000400040000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00044400000000444440000000499940000000400040000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000044400000000044400000000044400000000000000000000000000000000000000000000000000000000000000000000000000000000000000
